<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <!-- Bootstrap CSS -->
  <link href="/resources/bootstrap/bootstrap.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script src="/resources/babel/browser.min.js"></script>
  <script type="text/babel">
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');

      // Get references to the status and message fields
      const responseStatus = document.querySelector('#response-status');
      const responseMessage = document.querySelector('#response-message');

      switch(xhr.status) {
        case 200:
          
          break;
        case 201:
          
          break;
        case 204:
          
          break;
        case 400:
          
          break;
        case 404:
          
          break;
        default:
          
          break;
      }

      if(parseResponse) {
        const obj = JSON.parse(xhr.response);
        console.dir(obj);

        // Clear out the response-message from previous HEAD requests
        responseMessage.textContent = "";
        
        // Create a temporary element to store child row elements
        let tbody = document.querySelector("tbody");
        tbody.innerHTML = '';
        
        // Append a new row for each element
        for(let i = 0; i < obj.tasks.length; i++) {
          let tr = document.createElement("tr");
          tr.innerHTML = (
                `<td><input type="checkbox" ${obj.tasks[i].isDone}></td>`
              + `<td>${obj.tasks[i].taskId}</td>`
              + `<td>${obj.tasks[i].class}</td>`
              // If the link exists, transform the name into a hyperlink
              + `<td>${obj.tasks[i].link ? '<a href="' + obj.tasks[i].link + '">' : ''}Week 1.1 - Course Overview${obj.tasks[i].link ? '</a>' : ''}</td>`
              + `<td>${obj.tasks[i].time}</td>`
              + `<td>${obj.tasks[i].notes}</td>`
            );
          tr.querySelector("input").addEventListener('click', () => {console.log("TODO: Update post")});
          tbody.appendChild(tr);
        }
      } else {
        responseMessage.textContent = "Meta Data Received";
      }
    };

    const requestUpdate = (e, userForm) => {
      const url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;

      const xhr = new XMLHttpRequest();
      xhr.open(method, url);

      xhr.setRequestHeader('Accept', 'application/json');

      if(method === 'head') {
        xhr.onload = () => handleResponse(xhr, false);  
      } else {
        xhr.onload = () => handleResponse(xhr, true);
      }

      xhr.send();

      e.preventDefault();
      return false;
    };

    const sendPost = (e, newTaskForm) => {
        e.preventDefault();
        
        // TODO: Update documentation
        const taskAction = newTaskForm.getAttribute('action');
        const taskMethod = newTaskForm.getAttribute('method');

        // Get a reference to all fields
        const classField = newTaskForm.querySelector('#classField');
        const nameField = newTaskForm.querySelector('#nameField');
        const timeField = newTaskForm.querySelector('#timeField');
        const linkField = newTaskForm.querySelector('#linkField');
        const notesField = newTaskForm.querySelector('#notesField');

        const xhr = new XMLHttpRequest();
        xhr.open(taskMethod, taskAction);

        xhr.setRequestHeader('Accept', 'application/json');
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        xhr.onload = () => handleResponse(xhr);

        const formData = (
          `class=${classField.value}`
          + `&name=${nameField.value}`
          + `&time=${timeField.value}`
          + `&link=${linkField.value}`
          + `&notes=${notesField.value}`
          );
        xhr.send(formData);

        return false;
    };

    const init = () => {
      // Set up the Add User button to send a POST request
      const newTaskForm = document.querySelector('#newTaskForm');
      const addTask = (e) => sendPost(e, newTaskForm);
      newTaskForm.addEventListener('submit', addTask);

      // Set up the Get User button to send a request
      const getTasksForm = document.querySelector('#getTasksForm');
      const getTasks = (e) => requestUpdate(e, getTasksForm);
      getTasksForm.addEventListener('submit', getTasks);
    };

    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>Add New Task</h3>
    <form id="newTaskForm" action="/addTask" method="post"> <!-- TODO: POST /addTask -->
      <label for="class">Class*</label>
      <input id="classField" type="text" name="class" value="IGME-430" />
      <label for="name">Name*</label>
      <input id="nameField" type="text" name="name" value="Week 1.1 - Course Overview"/>
      <label for="time">Estimated Time*</label>
      <input id="timeField" type="text" name="time" placeholder="hh:mm" value="00:28"/>
      <label for="link">Link</label>
      <input id="linkField" type="text" name="link" value="https://mycourses.rit.edu/d2l/le/content/885922/viewContent/7226627/View"/>
      <label for="notes">Notes</label>
      <input id="notesField" type="text" name="notes" value="Optional: Link, Notes"/>
      <input type="submit" value="Add Task" />
    </form>
    <form id="getTasksForm" action="/getTasks" method="get">
      <select id='urlField'>
        <option value='/getTasks'>/getTasks</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get Tasks" />
    </form>
  </section>
  <section id="content">
    <h1 id="response-status"></h1>
    <p id="response-message"></p>
  </section>

  <table class="table">
    <thead>
      <tr>
        <td></td>
        <td>Task #</td>
        <td>Class</td>
        <td>Name</td>
        <td>Est. Time</td>
        <td>Notes</td>
      </tr>
    </thead>
    <tbody>
      <!-- GET /getTasks will insert its response into this body -->
    </tbody>
  </table>

  <!-- Toast notification in the top-right corner -->
  <div aria-live="polite" aria-atomic="true" id="toast-container">
    <div class="toast" data-autohide="false" data-delay=50000>
      <div class="toast-header">
        <!-- <img src="..." class="rounded mr-2" alt="..."> -->
        <strong class="mr-auto" id="toast-header-content">Server Response</strong>
      </div>
      <div class="toast-body" id="toast-body-content">
        Hello, world! This is a toast message.
      </div>
    </div>
  </div>
</body>
</html>
<!-- JavaScript Bundle with Popper -->
<script src="/resources/jquery/slim.min.js"></script>
<script src="/resources/ajax/popper.min.js"></script>
<script src="/resources/bootstrap/bundle.min.js"></script>
<!-- Custom JS -->
<script src="/src/toastNotifications.js"></script>